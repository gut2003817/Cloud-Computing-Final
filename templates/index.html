<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <div class="row justify-content-center mt-5">
        <div class="col-auto">
            <a href="/category/考試" class="btn category-btn btn-primary mx-2 py-2 px-4">
                考試
            </a>
        </div>
        <div class="col-auto">
            <a href="/category/作業" class="btn category-btn btn-success mx-2 py-2 px-4">
                作業
            </a>
        </div>
        <div class="col-auto">
            <a href="/category/日常" class="btn category-btn btn-warning mx-2 py-2 px-4">
                日常
            </a>
        </div>
    </div>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>待辦事項清單</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        body {
            background-color: #ffffff; /* 默認顏色，會被 JavaScript 覆蓋 */
            transition: background-color 0.3s ease; /* 添加平滑過渡效果 */
        }      
        .container {
            margin-top: 50px;
            background-color: #ffffff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
        }
        .todo-item {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        .completed {
            text-decoration: line-through;
            color: #6c757d;
        }
        .header-image {
            width: 100%;
            height: auto;
            margin-bottom: 20px;
            border-radius: 10px;
        }
        .overdue {
            color: red;
            font-weight: bold;
        }
        .in-progress {
            color: blue;
            font-weight: bold;
        }
        .category-btn {
            font-size: 1rem; /* 字型大小 */
            font-weight: bold; /* 加粗 */
            border-radius: 15px; /* 圓角 */
            transition: all 0.3s ease; /* 添加平滑過渡效果 */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* 陰影 */
        }
    
        .category-btn:hover {
            transform: translateY(-3px); /* 滑上效果 */
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15); /* 陰影加深 */
        }
    
        .category-btn:active {
            transform: translateY(1px); /* 點擊效果 */
            box-shadow: 0 3px 5px rgba(0, 0, 0, 0.1); /* 按下時陰影變淺 */
        }
        .row {
            margin-top: 50px; /* 與頁面頂部保持距離 */
        }
    </style>
    </style>
</head>
    <div class="container">
        <h1 class="text-center mb-4">{{ username }} 的待辦事項清單</h1>
        
        <div class="mb-4 text-center">
            <a href="/" class="btn btn-outline-primary {% if not category %}active{% endif %}">全部</a>
            <a href="/?category=incomplete" class="btn btn-outline-warning {% if category == 'incomplete' %}active{% endif %}">未完成</a>
            <a href="/?category=completed" class="btn btn-outline-success {% if category == 'completed' %}active{% endif %}">已完成</a>
        </div>

        <!-- 通知區塊 -->
        {% if reminders %}
        <div class="alert alert-warning alert-dismissible fade show" role="alert">
            <strong>提醒（2天內到期）：</strong>
            <ul>
                {% for reminder in reminders %}
                    <li>{{ reminder }}</li>
                {% endfor %}
            </ul>
            <div class="text-center mt-2">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="alert" aria-label="Close">關閉提醒</button>
            </div>
        </div>
        {% endif %}

        <!-- 新增待辦事項表單 -->
        <form action="/add" method="POST" class="mb-3">
            <div class="input-group mb-2">
                <input type="text" name="content" class="form-control" placeholder="輸入新的待辦事項" required>
            </div>
            <div class="input-group mb-3">
                <label for="due_date" class="mr-2">選擇執行或截止日期：</label>
                <input type="date" name="due_date" class="form-control" id="due_date">
            </div>
            <div class="d-flex justify-content-end mt-4">
                <button type="submit" class="btn btn-primary">新增</button>
            </div>
        </form>

        <!-- 待辦事項列表 -->
        <ul class="list-group">
            {% for todo in todos %}
            <li class="list-group-item todo-item {% if todo.completed %}completed{% endif %}">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <!-- 顯示狀態 -->
                        <span class="{% if todo.is_overdue %}overdue{% elif todo.in_progress %}in-progress{% else %}text-body{% endif %}">
                            {% if todo.in_progress %}進行中：{% endif %}{{ todo.content }}
                            {% if todo.is_overdue %}
                                <span class="ms-2">（已過期）</span>
                            {% endif %}
                        </span><br>
                        <small class="{% if todo.is_overdue %}text-danger{% else %}text-muted{% endif %}">
                            截止日期：{{ todo.due_date.strftime('%Y-%m-%d') if todo.due_date else '無截止日期' }}
                        </small>
                    </div>
                    <div>
                        <a href="/complete/{{ todo.id }}" class="btn btn-success btn-sm">{{ '未完成' if todo.completed else '完成' }}</a>
                        <a href="/progress/{{ todo.id }}" class="btn btn-primary btn-sm">{{ '停止執行' if todo.in_progress else '執行' }}</a>
                        <a href="javascript:void(0);" class="btn btn-warning btn-sm edit-btn" data-id="{{ todo.id }}" data-content="{{ todo.content }}" data-due-date="{{ todo.due_date.strftime('%Y-%m-%d') if todo.due_date else '' }}">編輯</a>
                        <a href="/delete/{{ todo.id }}" class="btn btn-danger btn-sm">刪除</a>
                    </div>
                </div>
            </li>
            {% endfor %}
        </ul>

        <!-- 編輯模態框 -->
        <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editModalLabel">編輯待辦事項</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="editForm">
                            <input type="hidden" id="editTodoId">
                            <div class="mb-3">
                                <label for="editContent" class="form-label">待辦事項</label>
                                <input type="text" class="form-control" id="editContent" required>
                            </div>
                            <div class="mb-3">
                                <label for="editDueDate" class="form-label">截止日期</label>
                                <input type="date" class="form-control" id="editDueDate">
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary" id="saveChanges">儲存變更</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 底部按鈕 -->
        <div class="text-center mt-4">
            <a href="/logout" class="btn btn-secondary mx-2">登出</a>
            <a href="/export" class="btn btn-success mx-2">匯出Excel</a>
        </div>
    </div>

    <script>
        // 編輯模態框邏輯
        document.querySelectorAll('.edit-btn').forEach(button => {
            button.addEventListener('click', function () {
                const todoId = this.getAttribute('data-id');
                const content = this.getAttribute('data-content');
                const dueDate = this.getAttribute('data-due-date');

                document.getElementById('editTodoId').value = todoId;
                document.getElementById('editContent').value = content;
                document.getElementById('editDueDate').value = dueDate;

                const modal = new bootstrap.Modal(document.getElementById('editModal'));
                modal.show();
            });
        });

        // 儲存變更請求
        document.getElementById('saveChanges').addEventListener('click', function () {
            const todoId = document.getElementById('editTodoId').value;
            const content = document.getElementById('editContent').value;
            const dueDate = document.getElementById('editDueDate').value;

            fetch(`/api/edit/${todoId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    content: content,
                    due_date: dueDate
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('待辦事項已更新');
                    location.reload();
                } else {
                    alert(data.message);
                }
            })
            .catch(error => {
                alert('發生錯誤，請稍後再試');
                console.error('Error:', error);
            });
        });
    </script>

    <script>
    document.addEventListener('DOMContentLoaded', function () {
        const colorPicker = document.getElementById('bg-color-picker');
        const body = document.body;
    
        // 從 LocalStorage 獲取背景顏色
        const savedColor = localStorage.getItem('backgroundColor');
        if (savedColor) {
            body.style.backgroundColor = savedColor;
            colorPicker.value = savedColor;
        }
    
        // 實時更新背景顏色
        colorPicker.addEventListener('input', function () {
            const selectedColor = colorPicker.value;
            body.style.backgroundColor = selectedColor;
    
            // 儲存顏色到 LocalStorage
            localStorage.setItem('backgroundColor', selectedColor);
        });
    });
</script>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>